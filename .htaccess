# üöó FICHIER .HTACCESS DE S√âCURIT√â FRLimousine
# Protection maximale contre DDoS, injections et attaques

# 1. PROTECTION DE BASE
<Files "*">
    Order Deny,Allow
    Deny from all
</Files>

# Autoriser l'acc√®s aux fichiers n√©cessaires
<Files "*.html">
    Allow from all
</Files>

<Files "*.css">
    Allow from all
</Files>

<Files "*.js">
    Allow from all
</Files>

<Files "*.php">
    Allow from all
</Files>

# 2. PROTECTION CONTRE LES ATTAQUES DDoS
# Rate limiting de base
<Location "*">
    # Limiter les connexions par IP (mod_security si disponible)
    # Bloquer les bots malveillants connus
    SetEnvIf user-agent "libwww-perl" bad_bot
    SetEnvIf user-agent "BBBike" bad_bot
    SetEnvIf user-agent "wget" bad_bot
    Deny from env=bad_bot
</Location>

# 3. PROTECTION CONTRE LES INJECTIONS SQL/XSS
<IfModule mod_rewrite.c>
    RewriteEngine On

    # Bloquer les requ√™tes suspectes
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2})
    RewriteRule .* - [F,L]

    # Prot√©ger contre les injections SQL
    RewriteCond %{QUERY_STRING} union.*select.*\(.*/union/select.* [NC]
    RewriteRule .* - [F,L]

    # Bloquer les acc√®s aux fichiers sensibles
    RewriteRule ^\.htaccess$ - [F,L]
    RewriteRule ^\.env$ - [F,L]
    RewriteRule ^config\.php$ - [F,L]
    RewriteRule ^backup.*$ - [F,L]

    # Rediriger les erreurs 404 vers une page personnalis√©e
    ErrorDocument 404 /404.html
    ErrorDocument 403 /403.html
</IfModule>

# 4. HEADERS DE S√âCURIT√â
<IfModule mod_headers.c>
    # Protection XSS
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"

    # Protection contre le clickjacking
    Header always set X-Frame-Options SAMEORIGIN

    # Forcer HTTPS (√† activer apr√®s configuration SSL)
    # Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"

    # Protection contre le mime sniffing
    Header always set X-Content-Type-Options nosniff

    # R√©f√©rer policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Content Security Policy de base
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'"

    # Permissions Policy (anciennement Feature Policy)
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
</IfModule>

# 5. PROTECTION CONTRE LES ATTAQUES PAR USER-AGENT
<IfModule mod_setenvif.c>
    # Bloquer les scanners et bots malveillants
    SetEnvIf user-agent "sqlmap" bad_bot
    SetEnvIf user-agent "nmap" bad_bot
    SetEnvIf user-agent "nikto" bad_bot
    SetEnvIf user-agent "w3af" bad_bot
    SetEnvIf user-agent "skipfish" bad_bot
    SetEnvIf user-agent "nessus" bad_bot
    SetEnvIf user-agent "openvas" bad_bot
    SetEnvIf user-agent "qualys" bad_bot
    SetEnvIf user-agent "acunetix" bad_bot
    SetEnvIf user-agent "havij" bad_bot
    SetEnvIf user-agent "bsqlbf" bad_bot

    Deny from env=bad_bot

    # Bloquer les requ√™tes sans user-agent
    SetEnvIf user-agent "^$" bad_bot
    Deny from env=bad_bot
</IfModule>

# 6. PROTECTION CONTRE LES HOTLINKS (images)
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?frlimousine\.fr [NC]
    RewriteCond %{REQUEST_FILENAME} \.(gif|jpg|jpeg|png|svg|webp)$ [NC]
    RewriteRule . - [F,L]
</IfModule>

# 7. COMPRESSION ET CACHE (optimisation s√©curit√©)
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
</IfModule>

# 8. PROTECTION CONTRE LES SPAMMERS
<RequireAll>
    Require all granted
    Require not expr "%{HTTP_USER_AGENT} =~ /libwww-perl/"
    Require not expr "%{HTTP_USER_AGENT} =~ /BBBike/"
    Require not expr "%{REQUEST_URI} =~ /\.env/"
    Require not expr "%{REQUEST_URI} =~ /config\.php/"
    Require not expr "%{REQUEST_URI} =~ /backup/"
</RequireAll>

# 9. LOGGING DE S√âCURIT√â
LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined-security
CustomLog logs/access-security.log combined-security

# 10. PROTECTION PHP ADDITIONNELLE
<IfModule mod_php.c>
    php_flag display_errors off
    php_flag log_errors on
    php_value error_log logs/php-errors.log
    php_flag expose_php off
    php_flag register_globals off
    php_flag magic_quotes_gpc off
    php_value max_input_time 30
    php_value max_execution_time 30
    php_value memory_limit 32M
    php_value post_max_size 8M
    php_value upload_max_filesize 2M
    php_value max_file_uploads 1
</IfModule>

# 11. PROTECTION CONTRE LES ATTAQUES PAR CHEMIN
<IfModule mod_rewrite.c>
    # Bloquer les travers√©es de r√©pertoire
    RewriteCond %{REQUEST_URI} \.\./ [OR]
    RewriteCond %{REQUEST_URI} \.\.\\ [OR]
    RewriteCond %{REQUEST_URI} \.\./ [NC]
    RewriteRule .* - [F,L]

    # Bloquer les tentatives d'acc√®s aux fichiers syst√®me
    RewriteRule ^(wp-admin|wp-content|wp-includes|administrator|admin) - [F,L]
</IfModule>

# 12. PROTECTION ANTI-DDoS AVANC√âE (si mod_evasive disponible)
<IfModule mod_evasive24.c>
    DOSHashTableSize    3097
    DOSPageCount        2
    DOSPageInterval     1
    DOSSiteCount        50
    DOSSiteInterval     1
    DOSBlockingPeriod   600
    DOSEmailNotify      contact@votre-domaine.ovh
    DOSLogDir           "/var/log/httpd/"
</IfModule>

# 13. PROTECTION CONTRE LES ATTAQUES SLOWLORIS
<IfModule mod_reqtimeout.c>
    RequestReadTimeout header=20-40,MinRate=500 body=20-40,MinRate=500
</IfModule>

# 14. FIN DU FICHIER .HTACCESS
# Derni√®re modification : S√©curisation maximale FRLimousine